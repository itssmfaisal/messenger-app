<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Messenger</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        .profile-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 60px;
        }
        .profile-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .profile-picture-section {
            text-align: center;
            margin-bottom: 30px;
        }
        .profile-picture-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #007bff;
            margin-bottom: 15px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .profile-picture-placeholder {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: #6c757d;
            margin: 0 auto 15px;
            border: 3px solid #dee2e6;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-group input[type="file"] {
            padding: 5px;
        }
        .file-info {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        .alert {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .profile-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #dee2e6;
        }
        .stat-item {
            text-align: center;
        }
        .stat-item .stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
        }
        .stat-item .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Messenger</h2>
                <div class="user-info">
                    <span th:text="${username}">User</span>
                    <a th:href="@{/logout}" class="logout-btn">Logout</a>
                </div>
            </div>
            
            <div class="sidebar-actions">
                <a th:href="@{/conversations}" class="btn btn-secondary">‚Üê Back to Conversations</a>
                <a th:if="${isAdmin}" th:href="@{/admin}" class="btn" style="background: #28a745; color: white; margin-top: 10px;">Admin Panel</a>
            </div>
        </div>
        
        <div class="main-content" style="overflow-y: auto; overflow-x: hidden;">
            <div class="profile-container">
                <div class="profile-header">
                    <h1>My Profile</h1>
                </div>
                
                <div th:if="${message}" class="alert alert-success" th:text="${message}"></div>
                <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>
                
                <form th:action="@{/profile/update}" method="post" enctype="multipart/form-data">
                    <div class="profile-picture-section">
                        <div th:if="${user.profilePicture != null and !user.profilePicture.isEmpty()}">
                            <img th:src="@{'/uploads/profile-pictures/' + ${user.profilePicture}}" 
                                 alt="Profile Picture" 
                                 class="profile-picture-preview"
                                 id="profilePreview">
                        </div>
                        <div th:unless="${user.profilePicture != null and !user.profilePicture.isEmpty()}" 
                             class="profile-picture-placeholder"
                             id="profilePlaceholder">
                            <span th:text="${user.username.substring(0, 1).toUpperCase()}">U</span>
                        </div>
                        <input type="file" 
                               id="profilePictureInput" 
                               name="profilePicture" 
                               accept="image/*"
                               onchange="previewImage(this)">
                        <div class="file-info">
                            Max file size: 2MB. Image will be compressed to ~800KB.
                        </div>
                        <div class="btn-group" style="justify-content: center;">
                            <button type="button" 
                                    class="btn" 
                                    style="background: #dc3545; color: white;"
                                    th:if="${user.profilePicture != null and !user.profilePicture.isEmpty()}"
                                    onclick="deleteProfilePicture()">
                                Remove Picture
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" 
                               id="username" 
                               th:value="${user.username}" 
                               disabled
                               style="background: #e9ecef;">
                        <small style="color: #6c757d;">Username cannot be changed</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" 
                               id="email" 
                               name="email" 
                               th:value="${user.email}"
                               required>
                    </div>
                    
                    <div class="form-group">
                        <label for="fullName">Full Name</label>
                        <input type="text" 
                               id="fullName" 
                               name="fullName" 
                               th:value="${user.fullName}"
                               placeholder="Enter your full name">
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary" style="width: 100%;">Update Profile</button>
                    </div>
                </form>
                
                <div class="profile-stats">
                    <div class="stat-item">
                        <div class="stat-label">Account Created</div>
                        <div class="stat-value" style="font-size: 14px;" th:text="${#temporals.format(user.createdAt, 'MMM yyyy')}"></div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Status</div>
                        <div class="stat-value" style="font-size: 14px;">
                            <span th:text="${user.isOnline ? 'Online' : 'Offline'}" 
                                  th:style="${user.isOnline ? 'color: #28a745;' : 'color: #6c757d;'}"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <form id="deletePictureForm" th:action="@{/profile/picture/delete}" method="post" style="display: none;"></form>
    
    <script>
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                // Check file size (2MB)
                if (file.size > 2 * 1024 * 1024) {
                    alert('File size exceeds 2MB limit. Please choose a smaller image.');
                    input.value = '';
                    return;
                }
                
                // Check file type
                if (!file.type.startsWith('image/')) {
                    alert('Please select an image file.');
                    input.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('profilePreview');
                    const placeholder = document.getElementById('profilePlaceholder');
                    
                    if (preview) {
                        preview.src = e.target.result;
                    } else if (placeholder) {
                        placeholder.style.display = 'none';
                        const img = document.createElement('img');
                        img.id = 'profilePreview';
                        img.className = 'profile-picture-preview';
                        img.src = e.target.result;
                        img.alt = 'Profile Picture';
                        placeholder.parentNode.insertBefore(img, placeholder);
                    }
                };
                reader.readAsDataURL(file);
            }
        }
        
        function deleteProfilePicture() {
            if (confirm('Are you sure you want to remove your profile picture?')) {
                document.getElementById('deletePictureForm').submit();
            }
        }
    </script>
</body>
</html>

